<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Receipt Interceptor Setup</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 32px;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .header p {
      color: #718096;
      font-size: 16px;
    }

    .content {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
    }

    .wizard-step {
      display: none;
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .wizard-step.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-title {
      font-size: 24px;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .step-description {
      color: #718096;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group input:disabled {
      background: #f7fafc;
      color: #a0aec0;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button.secondary {
      background: #e2e8f0;
      color: #2d3748;
    }

    button.secondary:hover {
      background: #cbd5e0;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 10px;
    }

    .status-badge.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-badge.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .status-badge.warning {
      background: #feebc8;
      color: #744210;
    }

    .dashboard {
      display: none;
      max-width: 800px;
      margin: 0 auto;
    }

    .dashboard.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #718096;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 36px;
      font-weight: 700;
      color: #2d3748;
    }

    .logs-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
    }

    .logs-container h3 {
      margin-bottom: 15px;
      color: #2d3748;
    }

    .log-entry {
      padding: 8px 12px;
      margin-bottom: 5px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .log-entry.info {
      background: #e6fffa;
      color: #234e52;
    }

    .log-entry.warn {
      background: #feebc8;
      color: #744210;
    }

    .log-entry.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .info-box {
      background: #ebf8ff;
      border-left: 4px solid #4299e1;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }

    .info-box strong {
      display: block;
      margin-bottom: 5px;
      color: #2c5282;
    }

    .info-box p {
      color: #2c5282;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Receipt Interceptor</h1>
      <p>Automatic receipt capture for your loyalty system</p>
    </div>

    <div class="content">
      <!-- Welcome Step -->
      <div class="wizard-step active" id="step-welcome">
        <div class="step-title">Welcome!</div>
        <div class="step-description">
          This setup wizard will configure the Receipt Interceptor for your restaurant.
          The entire process takes less than 2 minutes.
        </div>

        <div class="info-box">
          <strong>What this does:</strong>
          <p>Automatically captures receipt data from your POS system and sends it to your loyalty platform in real-time. Zero staff training required.</p>
        </div>

        <div class="button-group">
          <button class="primary" onclick="nextStep()">Get Started</button>
        </div>
      </div>

      <!-- System Check Step -->
      <div class="wizard-step" id="step-system">
        <div class="step-title">System Check</div>
        <div class="step-description">
          Checking your system requirements...
        </div>

        <div class="form-group">
          <label>Windows Print Spooler</label>
          <div id="spooler-status">Checking...</div>
        </div>

        <div class="form-group">
          <label>Terminal ID (Auto-generated)</label>
          <input type="text" id="terminal-id" disabled>
        </div>

        <div class="button-group">
          <button class="secondary" onclick="prevStep()">Back</button>
          <button class="primary" id="system-next" disabled onclick="nextStep()">Continue</button>
        </div>
      </div>

      <!-- Configuration Step -->
      <div class="wizard-step" id="step-config">
        <div class="step-title">Connect to Cloud</div>
        <div class="step-description">
          Enter your loyalty system API details. You can find these in your dashboard.
        </div>

        <div class="form-group">
          <label>API Endpoint</label>
          <input type="text" id="api-endpoint" placeholder="https://your-api.com">
        </div>

        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="api-key" placeholder="Your API key">
        </div>

        <div id="connection-status"></div>

        <div class="button-group">
          <button class="secondary" onclick="prevStep()">Back</button>
          <button class="primary" onclick="testConnection()">Test Connection</button>
        </div>
      </div>

      <!-- Complete Step -->
      <div class="wizard-step" id="step-complete">
        <div class="step-title">Setup Complete!</div>
        <div class="step-description">
          Your Receipt Interceptor is configured and ready to go.
        </div>

        <div class="info-box">
          <strong>What happens next:</strong>
          <p>The interceptor will start automatically and run in the background. You'll see it in your system tray. Every receipt will now be captured and sent to your loyalty system automatically.</p>
        </div>

        <div class="form-group">
          <label>Terminal ID</label>
          <input type="text" id="terminal-id-final" disabled>
        </div>

        <div class="button-group">
          <button class="primary" onclick="finishSetup()">Start Interceptor</button>
        </div>
      </div>

      <!-- Dashboard -->
      <div class="dashboard" id="dashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Receipts Processed</h3>
            <div class="value" id="stat-receipts">0</div>
          </div>
          <div class="stat-card">
            <h3>Failed</h3>
            <div class="value" id="stat-failed">0</div>
          </div>
          <div class="stat-card">
            <h3>Status</h3>
            <div class="value" style="font-size: 18px;">
              <span id="stat-status" class="status-badge success">Running</span>
            </div>
          </div>
          <div class="stat-card">
            <h3>Last Receipt</h3>
            <div class="value" style="font-size: 16px;" id="stat-last">Never</div>
          </div>
        </div>

        <div class="logs-container">
          <h3>Recent Activity</h3>
          <div id="logs"></div>
        </div>

        <div class="button-group" style="margin-top: 20px;">
          <button class="secondary" onclick="stopInterceptor()">Stop</button>
          <button class="secondary" onclick="openLogs()">View Logs</button>
          <button class="primary" onclick="showSettings()">Settings</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ipcRenderer = window.electronAPI;
    let currentStep = 0;
    const steps = ['welcome', 'system', 'config', 'complete'];

    async function nextStep() {
      if (currentStep === 1) {
        await checkSystem();
      }

      if (currentStep < steps.length - 1) {
        document.getElementById(`step-${steps[currentStep]}`).classList.remove('active');
        currentStep++;
        document.getElementById(`step-${steps[currentStep]}`).classList.add('active');

        if (currentStep === 1) {
          await loadSystemInfo();
        }
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        document.getElementById(`step-${steps[currentStep]}`).classList.remove('active');
        currentStep--;
        document.getElementById(`step-${steps[currentStep]}`).classList.add('active');
      }
    }

    async function loadSystemInfo() {
      const config = await ipcRenderer.invoke('get-config');
      document.getElementById('terminal-id').value = config.terminalId;
      document.getElementById('terminal-id-final').value = config.terminalId;

      const spooler = await ipcRenderer.invoke('check-spooler');
      const statusEl = document.getElementById('spooler-status');

      if (spooler.running) {
        statusEl.innerHTML = '<span class="status-badge success">Running</span>';
        document.getElementById('system-next').disabled = false;
      } else if (spooler.installed) {
        statusEl.innerHTML = '<span class="status-badge warning">Not running</span> <button onclick="startSpooler()">Start</button>';
      } else {
        statusEl.innerHTML = '<span class="status-badge error">Not installed</span>';
      }
    }

    async function startSpooler() {
      const result = await ipcRenderer.invoke('start-spooler');
      if (result.success) {
        loadSystemInfo();
      }
    }

    async function checkSystem() {
      const spooler = await ipcRenderer.invoke('check-spooler');
      return spooler.running;
    }

    async function testConnection() {
      const endpoint = document.getElementById('api-endpoint').value;
      const apiKey = document.getElementById('api-key').value;

      if (!endpoint || !apiKey) {
        document.getElementById('connection-status').innerHTML =
          '<span class="status-badge error">Please fill in all fields</span>';
        return;
      }

      const statusEl = document.getElementById('connection-status');
      statusEl.innerHTML = '<span class="status-badge warning"><span class="spinner"></span>Testing connection...</span>';

      const result = await ipcRenderer.invoke('test-connection', endpoint, apiKey);

      if (result.success) {
        statusEl.innerHTML = '<span class="status-badge success">Connection successful!</span>';

        const config = await ipcRenderer.invoke('get-config');
        config.apiEndpoint = endpoint;
        config.apiKey = apiKey;
        await ipcRenderer.invoke('save-config', config);

        setTimeout(() => nextStep(), 1000);
      } else {
        statusEl.innerHTML = `<span class="status-badge error">Failed: ${result.error || 'Invalid credentials'}</span>`;
      }
    }

    async function finishSetup() {
      const config = await ipcRenderer.invoke('get-config');
      config.setupComplete = true;
      await ipcRenderer.invoke('save-config', config);

      await ipcRenderer.invoke('start-interceptor');

      document.getElementById('step-complete').classList.remove('active');
      document.getElementById('dashboard').classList.add('active');

      startStatusUpdates();
    }

    async function stopInterceptor() {
      await ipcRenderer.invoke('stop-interceptor');
    }

    async function openLogs() {
      await ipcRenderer.invoke('open-logs');
    }

    function showSettings() {
      document.getElementById('dashboard').classList.remove('active');
      currentStep = 2;
      document.getElementById('step-config').classList.add('active');
    }

    function startStatusUpdates() {
      setInterval(async () => {
        const status = await ipcRenderer.invoke('get-status');
        updateDashboard(status);
      }, 2000);
    }

    function updateDashboard(status) {
      if (status.stats) {
        document.getElementById('stat-receipts').textContent = status.stats.receiptsProcessed || 0;
        document.getElementById('stat-failed').textContent = status.stats.receiptsFailed || 0;

        const statusBadge = document.getElementById('stat-status');
        if (status.running && status.stats.healthy) {
          statusBadge.className = 'status-badge success';
          statusBadge.textContent = 'Running';
        } else if (status.running) {
          statusBadge.className = 'status-badge warning';
          statusBadge.textContent = 'Issues';
        } else {
          statusBadge.className = 'status-badge error';
          statusBadge.textContent = 'Stopped';
        }

        if (status.stats.lastReceipt) {
          const elapsed = Date.now() - status.stats.lastReceipt;
          const minutes = Math.floor(elapsed / 60000);
          document.getElementById('stat-last').textContent =
            minutes < 1 ? 'Just now' : `${minutes}m ago`;
        }
      }
    }

ipcRenderer.on('status-update', (stats) => {
  updateDashboard({ running: true, stats });
});

ipcRenderer.on('log-message', (log) => {
  const logsEl = document.getElementById('logs');
  const entry = document.createElement('div');
  entry.className = `log-entry ${log.level || 'info'}`;
  // guard timestamp
  const ts = log.timestamp ? new Date(log.timestamp) : new Date();
  entry.textContent = `${ts.toLocaleTimeString()} - ${log.message || JSON.stringify(log)}`;
  logsEl.insertBefore(entry, logsEl.firstChild);

  while (logsEl.children.length > 50) {
    logsEl.removeChild(logsEl.lastChild);
  }
});

ipcRenderer.on('show-settings', () => {
  showSettings();
});


    // Check if already configured
    (async () => {
      const config = await ipcRenderer.invoke('get-config');
      if (config.setupComplete) {
        document.querySelector('.wizard-step.active').classList.remove('active');
        document.getElementById('dashboard').classList.add('active');
        startStatusUpdates();
      }
    })();
  </script>
</body>
</html>
